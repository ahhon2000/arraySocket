#!/usr/bin/python3
try: from pathlib import Path as P; R = P.resolve; E = P.exists; \
    L = lambda p: p / 'cfg.py'; F = R(P(__file__)); import handyPyUtil
except: O=open(R(next(filter(E,map(L,F.parents))))); exec(O.read()); O.close()

inclPath()

import time
from threading import Thread, Event

import client, server
from TestKitAS import TestKitAS

with TestKitAS() as tk:
    class CMAClass_srv(server.ClientMessageArray):
        def on_auth(self, m):
            super().on_auth(m, authEveryone=True)

    class SMAClass_cli(client.ServerMessageArray):
        def on_auth(self, m):
            authExchange.set()
            super().on_auth(m)

    srvProc = tk.startServer(CMAClass = CMAClass_srv)
    authExchange = Event()

    time.sleep(0.1)
    cli, thCli = tk.startClient(SMAClass=SMAClass_cli)

    authExchange.wait(0.1)
    cli.stop()

    assert authExchange.isSet()
