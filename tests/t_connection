#!/usr/bin/python3
from pathlib import Path as P; E=P.exists;R=P.resolve; l=R(P(__file__)).parents
with open(R(next(filter(E,(p/'cfg.py' for p in l))))) as _:exec(_.read())

inclPath()

import time
from threading import Thread, Event

import client, server
from TestKitAS import TestKitAS

with TestKitAS() as tk:
    class CMAClass_srv(server.ClientMessageArray):
        def on_auth(self, m):
            super().on_auth(m, authEveryone=True)

    class SMAClass_cli(client.ServerMessageArray):
        def on_auth(self, m):
            authExchange.set()
            super().on_auth(m)

    srvProc = tk.startServer(CMAClass = CMAClass_srv)
    authExchange = Event()

    time.sleep(0.1)
    cli, thCli = tk.startClient(SMAClass=SMAClass_cli)

    authExchange.wait(0.1)
    cli.stop()

    assert authExchange.isSet()
